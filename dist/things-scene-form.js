!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@hatiolab/things-scene"),require("xml-js"),require("hls.js"),require("tinycolor2")):"function"==typeof define&&define.amd?define(["exports","@hatiolab/things-scene","xml-js","hls.js","tinycolor2"],t):t((e=e||self)["things-scene-form"]={},e.scene,e.xmlJs,e.Hls,e.tinycolor)}(this,function(e,t,a,n,s){"use strict";n=n&&n.hasOwnProperty("default")?n.default:n,s=s&&s.hasOwnProperty("default")?s.default:s;const r={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"select",label:"method",name:"method",property:{options:[{display:"GET",value:"GET"},{display:"POST",value:"POST"}]}},{type:"string",label:"action",name:"action"},{type:"number",label:"period",name:"period"},{type:"string",label:"name",name:"name"},{type:"string",label:"authorization",name:"authorization"},{type:"select",label:"format",name:"format",property:{options:[{display:"JSON",value:"JSON"},{display:"XML",value:"XML"},{display:"TEXT",value:"TEXT"}]}},{type:"checkbox",label:"with-credentials",name:"withCredentials"},{type:"checkbox",label:"submit-on-load",name:"submitOnLoad"},{type:"checkbox",label:"debug",name:"debug"}],"value-property":"action"};class l extends t.HTMLOverlayContainer{dispose(){super.dispose(),this._stopRepeater()}setElementProperties(e){var{action:t="",method:a="POST",name:n=""}=this.state;e.action=t,e.method=a,e.name=n}get action(){return this.state.action}set action(e){this.setState("action",e),this._startRepeater()}get period(){return 1e3*this.state.period}set period(e){this.setState("period",e),this._startRepeater()}_startRepeater(){this._stopRepeater(),this.app.isViewMode&&this.period&&(this._repeatInterval=setInterval(this._submit.bind(this),this.period))}_stopRepeater(){this._repeatInterval&&clearInterval(this._repeatInterval)}_onload(e){var t=e.target.response;try{switch(this.get("format")){case"JSON":t=JSON.parse(t);break;case"XML":t=a.xml2js(t,{compact:!0})}this.state.debug&&console.log("[FORM-RESULT]",t),this.setState("data",t)}catch(e){console.error(e)}}oncreate_element(e){if(this.app.isViewMode){e.onsubmit=(t=>{t.preventDefault();var a=e.action,n=new XMLHttpRequest,s=[].filter.call(e.elements,function(e){return"radio"!=e.type&&"checkbox"!=e.type||e.checked}).filter(function(e){return!!e.name}).filter(function(e){return!e.disabled}).map(function(e){return encodeURIComponent(e.name)+"="+encodeURIComponent(e.value)}).join("&");return n.onloadend=this._onload.bind(this),"get"==e.method?n.open(e.method,a+"?"+s):n.open(e.method,a),n.setRequestHeader("Content-Type",["x-www-form-urlencoded","json"].map(e=>"application/"+e).concat("text/plain").join(";")),this.get("authorization")&&n.setRequestHeader("Authorization",this.get("authorization")),this.get("withCredentials")&&(n.withCredentials=!0),"get"==e.method?n.send():n.send(s),!1}),this.getState("submitOnLoad")&&setTimeout(this._submit.bind(this),100),this._startRepeater()}}_submit(){this.element.dispatchEvent(new Event("submit",{cancelable:!0}))}get nature(){return r}}t.Component.register("form",l);const i={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"legend",name:"legend"}]};class o extends t.HTMLOverlayContainer{setElementProperties(e){var{legend:t=""}=this.state;t?this.legendElement.textContent=t:(this._legendElement&&this.element.removeChild(this._legendElement),delete this._legendElement)}get legendElement(){if(!this._legendElement){var e=document.createElement("legend");this.element.appendChild(e),this._legendElement=e}return this._legendElement}get nature(){return i}}t.Component.register("fieldset",o);const p={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"value",name:"value"},{type:"number",label:"size",name:"size"},{type:"string",label:"name",name:"name"},{type:"checkbox",label:"submit-on-change",name:"submitOnChange"},{type:"checkbox",label:"copy-value-to-data",name:"copyValueToData"},{type:"string",label:"text-field",name:"textField"},{type:"string",label:"value-field",name:"valueField"},{type:"options",label:"options",name:"options"}],"value-property":"value"};class m extends t.HTMLOverlayElement{get nature(){return p}buildOptions(){var e,{options:t=[],textField:a,valueField:n,value:s}=this.state;!t instanceof Array&&(t=[]),this.element.textContent="",t.map&&t.map((t,s)=>{let r,l;return r=a?"(index)"==a?s:t&&t[a]||String.fromCharCode(160):t&&(t.text||t),l=n?"(index)"==n?s:t&&t[n]:t&&(t.value||t),void 0===e&&(e=l),l==this.value&&(e=this.value),{text:r,value:l}}).forEach(e=>{var t=document.createElement("option");t.value="string"==typeof e.value?e.value:JSON.stringify(e.value),t.text=e.text,this.element.appendChild(t)}),void 0!==e&&this.value!==e&&(this.value=JSON.stringify(e)),this.element.value!=this.value&&(this.element.value=this.value,this.element.dispatchEvent(new Event("change")))}createElement(){super.createElement(),this.buildOptions();var e=this.element;e.value=this.get("value")||"",e.onchange=(t=>{this.set("value",e.value),this.get("submitOnChange")&&e.form&&e.form.dispatchEvent(new Event("submit",{cancelable:!0}))})}setElementProperties(e){var{size:t,name:a}=this.state;e.size=t,e.name=a}onchange(e,t){if(super.onchange(e,t),"value"in e&&this.element){if(this.element.value=e.value,this.get("copyValueToData"))try{this.data=JSON.parse(e.value)}catch(t){this.data=e.value}this.get("submitOnChange")&&this.element.form&&this.element.form.dispatchEvent(new Event("submit",{cancelable:!0}))}"options"in e&&this.buildOptions()}get options(){return this.getState("options")}set options(e){this.setState("options",e)}}t.Component.register("select",m);const h={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"name",name:"name"},{type:"string",label:"value",name:"text"},{type:"string",label:"placeholder",name:"placeholder"},{type:"checkbox",label:"readonly",name:"readonly"},{type:"checkbox",label:"disabled",name:"disabled"},{type:"number",label:"max-length",name:"maxlength"}],"value-property":"text"};class u extends t.HTMLOverlayElement{get nature(){return h}get tagName(){return"textarea"}createElement(){super.createElement(),this.element.style.resize="none",this.element.onchange=(e=>{this.value=this.element.value})}setElementProperties(e){var{name:t="",placeholder:a="",disabled:n,readonly:s,maxlength:r}=this.state;try{e.name=t,e.placeholder=a,e.disabled=n,e.readonly=s,e.maxlength=r,e.value=this.value}catch(e){error(e)}this.data=this.value}}t.Component.register("textarea",u);const c={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"value",name:"text"}],"value-property":"text"};class d extends t.HTMLOverlayElement{get tagName(){return"button"}get nature(){return c}setElementProperties(e){this.element.textContent=this.value}}t.Component.register("button",d);const b={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"name",name:"name"},{type:"string",label:"value",name:"text"},{type:"string",label:"placeholder",name:"placeholder"},{type:"checkbox",label:"readonly",name:"readonly"},{type:"checkbox",label:"disabled",name:"disabled"},{type:"number",label:"max-length",name:"maxlength"},{type:"checkbox",label:"submit-on-change",name:"submitOnChange"}],"value-property":"text"};class g extends t.HTMLOverlayElement{get nature(){return b}get tagName(){return"input"}get inputType(){return this.get("type").substr(6)}createElement(){super.createElement(),this.element.onchange=(e=>{this.value=this.element.value})}setElementProperties(e){var{name:a="",placeholder:n="",disabled:s,readonly:r,maxlength:l}=this.state;try{e.type=this.inputType,e.name=a,e.placeholder=n,e.disabled=s,e.readonly=r,e.maxlength=l,e.value=this.value}catch(e){t.error(e)}this.data=this.value}onchange(e,t){super.onchange(e,t);var a=this.nature["value-property"];a&&a in e&&this.element&&(this.element.value=e.text,this.get("submitOnChange")&&this.element.form&&this.element.form.dispatchEvent(new Event("submit",{cancelable:!0})))}}["input","input-text","input-password","input-email","input-search","input-time","input-datetime-local","input-month","input-week"].forEach(e=>t.Component.register(e,g));const y={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"value",name:"value"},{type:"number",label:"size",name:"size"},{type:"string",label:"name",name:"name"},{type:"checkbox",label:"checked",name:"checked"}],"value-property":"value"};class v extends g{get nature(){return y}get tagName(){return"input"}get inputType(){return"radio"}createElement(){if(this.element=document.createElement("label"),this.element){var e=document.createElement("input");this.element.appendChild(e);var a=document.createTextNode(this.get("text"));this.element.appendChild(a),this.setElementProperties(this.element),this.parent.isHTMLElement&&this.parent.isHTMLElement()?this.parent.element.appendChild(this.element):this.root.model_layer.overlay.appendChild(this.element),t.Component.reposition(this),this.oncreate_element&&this.oncreate_element(this.element)}}setElementProperties(e){var t=this.element.querySelector("text"),a=this.element.querySelector("input"),{text:n,checked:s,value:r}=this.state;t&&(t.textContent=n),a&&(a.checked=s,a.value=r),super.setElementProperties(a)}}t.Component.register("input-radio",v);const x={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"value",name:"value"},{type:"number",label:"size",name:"size"},{type:"string",label:"name",name:"name"},{type:"checkbox",label:"checked",name:"checked"},{type:"checkbox",label:"submit-on-change",name:"submitOnChange"}],"value-property":"value"};class E extends g{get nature(){return x}get tagName(){return"input"}get inputType(){return"checkbox"}get hasTextProperty(){return!0}createElement(){if(this.element=document.createElement("label"),this.element){var e=document.createElement("input");this.element.appendChild(e);var a=document.createTextNode(this.get("text"));this.element.appendChild(a),this.setElementProperties(this.element),this.parent.isHTMLElement&&this.parent.isHTMLElement()?this.parent.element.appendChild(this.element):this.root.model_layer.overlay.appendChild(this.element),t.Component.reposition(this),this.oncreate_element&&this.oncreate_element(this.element)}}setElementProperties(e){var t=this.element.querySelector("text"),a=this.element.querySelector("input"),{text:n,checked:s,value:r}=this.state;t&&(t.textContent=n),a&&(a.checked=s,a.value=r),super.setElementProperties(a)}}t.Component.register("input-checkbox",E);const A={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"src",name:"src"}],"value-property":"src"};class f extends t.HTMLOverlayElement{setElementProperties(e){var{src:t=""}=this.state;e.src!=t&&(e.src=t)}get nature(){return A}}t.Component.register("iframe",f);const C={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"src",name:"src"}],"value-property":"src"};class S extends t.HTMLOverlayElement{setElementProperties(e){var{src:t=""}=this.state;e.src!=t&&(e.src=t)}get src(){return this.get("src")}set src(e){this.set("src",e)}get nature(){return C}}t.Component.register("img",S);const T={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"src",name:"src"},{type:"checkbox",label:"started",name:"started"},{type:"checkbox",label:"controls",name:"controls"}],"value-property":"src"};class _ extends t.HTMLOverlayElement{async oncreate_element(e){var{src:t,started:a}=this.state;e.addEventListener("canplay",()=>{this.started&&e.play()}),this.onchangesrc(t),this.onchangestarted(a)}dispose(){this.reset(),super.dispose()}reset(){this._hlsSupporter&&this._hlsSupporter.destroy(),delete this._hlsSupporter}onchange(e,t){super.onchange(e,t),"src"in e&&this.onchangesrc(e.src),"started"in e&&this.onchangestarted(e.started)}setElementProperties(e){var{controls:t}=this.state;t?e.setAttribute("controls",!0):e.removeAttribute("controls")}onchangestarted(e){var t=this.element;e?4==t.readyState&&t.play():t.pause()}onchangesrc(e){this.reset();var t=this.element;t&&(t.src=e,e.endsWith(".m3u8")&&n.isSupported()&&(this._hlsSupporter=new n,this._hlsSupporter.loadSource(e),this._hlsSupporter.attachMedia(t),this._hlsSupporter.on(n.Events.MANIFEST_PARSED,()=>{this.started&&t.play()})))}get src(){return this.getState("src")}set src(e){this.setState("src",e)}get started(){return this.getState("started")}set started(e){this.setState("started",e)}get nature(){return T}}t.Component.register("video",_);const O={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"href",name:"href",property:"href"},{type:"select",label:"target",name:"target",property:{options:[{display:"self",value:"_self"},{display:"blank",value:"_blank"},{display:"parent",value:"_parent"},{display:"top",value:"_top"}]}}],"value-property":"href"};class k extends t.HTMLOverlayContainer{get tagName(){return"a"}get href(){return this.get("href")}set href(e){this.set("href",e)}setElementProperties(e){var{href:t="",target:a}=this.state;e.href!=t&&(e.href=t),e.target=a,0==this.components.length&&(this.element.textContent=this.text||t)}get nature(){return O}}t.Component.register("link",k);const M={mutable:!1,resizable:!0,rotatable:!0};class P extends t.HTMLOverlayContainer{setElementProperties(e){e.textContent=this.text}get tagName(){return"div"}get nature(){return M}}t.Component.register("div",P);const w={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"name",name:"name"},{type:"number",label:"value",name:"text"},{type:"number",label:"min",name:"min"},{type:"number",label:"max",name:"max"},{type:"number",label:"step",name:"step"},{type:"checkbox",label:"submit-on-change",name:"submitOnChange"}],"value-property":"text"};class R extends g{get nature(){return w}setElementProperties(e){super.setElementProperties(e);var{min:t=0,max:a=100,step:n=1}=this.state;e.min=t,e.max=a,e.step=n}}t.Component.register("input-number",R),t.Component.register("input-range",R);const z={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"name",name:"name"},{type:"date",label:"value",name:"text"},{type:"date",label:"min",name:"min"},{type:"date",label:"max",name:"max"},{type:"checkbox",label:"submit-on-change",name:"submitOnChange"}],"value-property":"text"};class L extends g{get nature(){return z}setElementProperties(e){super.setElementProperties(e);var{min:t,max:a}=this.state;e.min=t,e.max=a}}t.Component.register("input-date",L);const H={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"name",name:"name"},{type:"string",label:"value",name:"text"},{type:"checkbox",label:"multiple",name:"multiple"}],"value-property":"text"};class N extends g{get nature(){return H}setElementProperties(e){super.setElementProperties(e),e.multiple=!!this.state.multiple}}t.Component.register("input-file",N);const I={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"name",name:"name"},{type:"color",label:"value",name:"text",property:{withoutAlpha:!0,valueType:"hex"}}],"value-property":"text"};class q extends g{get nature(){return I}setElementProperties(e){this.value=s(this.value||"#000000").toHexString(),super.setElementProperties(e)}}t.Component.register("input-color",q);const F={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"name",name:"name"},{type:"string",label:"value",name:"text"}],"value-property":"text"};class V extends g{get nature(){return F}setElementProperties(e){super.setElementProperties(e)}}t.Component.register("input-button",V),t.Component.register("input-submit",V),t.Component.register("input-reset",V);const j={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"string",label:"endpoint",name:"endpoint"},{type:"string",label:"soap-action",name:"soapAction"},{type:"string",label:"namespace",name:"namespace"},{type:"number",label:"period",name:"period"},{type:"string",label:"name",name:"name"},{type:"string",label:"authorization",name:"authorization"},{type:"checkbox",label:"with-credentials",name:"withCredentials"},{type:"checkbox",label:"submit-on-load",name:"submitOnLoad"},{type:"checkbox",label:"debug",name:"debug"}],"value-property":"endpoint"};class D extends t.HTMLOverlayContainer{dispose(){super.dispose(),this._stopRepeater()}get tagName(){return"form"}setElementProperties(e){var{endpoint:t="",name:a=""}=this.state;e.action=t,e.method="POST",e.name=a}get endpoint(){return this.state.endpoint}set endpoint(e){this.setState("endpoint",e),this._startRepeater()}get period(){return 1e3*this.state.period}set period(e){this.setState("period",e),this._startRepeater()}_startRepeater(){this._stopRepeater(),this.app.isViewMode&&this.period&&(this._repeatInterval=setInterval(this._submit.bind(this),this.period))}_stopRepeater(){this._repeatInterval&&clearInterval(this._repeatInterval)}_onload(e){var t=e.target.response;try{t=a.xml2js(t,{compact:!0}),this.state.debug&&console.log("[SOAP-RESULT]",t),this.setState("data",t)}catch(e){console.error(e)}}oncreate_element(e){if(this.app.isViewMode){e.onsubmit=(t=>{t.preventDefault();var{endpoint:a,soapAction:n,namespace:s}=this.state,r=new XMLHttpRequest,l=[].filter.call(e.elements,e=>"radio"!=e.type&&"checkbox"!=e.type||e.checked).filter(e=>!!e.name).filter(e=>!e.disabled).map(e=>`<${e.name}>${e.value}</${e.name}>`).join("\n      ");r.onloadend=this._onload.bind(this),r.open("POST",a),r.setRequestHeader("Content-Type","text/xml"),r.setRequestHeader("SOAPAction",""),this.get("authorization")&&r.setRequestHeader("Authorization",this.get("authorization")),this.get("withCredentials")&&(r.withCredentials=!0);let i=`\n<s:Envelope \n  xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">\n  <s:Header/>\n  <s:Body>\n    <ns0:${n} xmlns:ns0="${s}">\n      ${l}\n    </ns0:${n}>\n  </s:Body>\n</s:Envelope>\n`;return console.log("soapEnvelope",i),r.send(i),!1}),this.getState("submitOnLoad")&&setTimeout(this._submit.bind(this),100),this._startRepeater()}}_submit(){this.element.dispatchEvent(new Event("submit",{cancelable:!0}))}get nature(){return j}}t.Component.register("soap-client",D);const U={mutable:!1,resizable:!0,rotatable:!0,properties:[{type:"textarea",label:"template",name:"template"},{type:"string",label:"apply-to",name:"applyTo"}]},B={type:"pattern",fitPattern:!0,image:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAAAMFBMVEUAAAAdHR0AAAAAAAAAAAAREREODg4AAAATExMAAAAAAAAAAAAAAAAAAAAWFhYAAABtUS6TAAAAD3RSTlMArnboZDwVtVUHmMTU9CygGbkuAAABBklEQVR42u3Vy47DMAgFUMbE78f9/7+dqpVKFNUzwKqLnD0RvjGYbrdvF8tK9JBWieTRAO6tdQYyeWS8DfIYeONEdmlCLE+GOClkV3ASyC7gpPn+ouiODAdOeJkjHMAZF2OCE1eHK0BfkLXho5yU8XVsjKWKj7E1iya/44kvpcdLJa3LOdg3zIIr2fg7qEd4umYQXpJqiPZyVbQwsMXJtoq889CwkUknMT6ai5QOfBRcb4oY1fMmiBnV1TFk+YDooST6T30UM7a4h5hoS4r/wjnEusleLeiusPFKFwhXCx0GXHUjZBmrDJNRfQ2IYthDYv/grwmrqG1AtV0ShKuF+ONQ6Hb7Hr9EkkNRgwrYbAAAAABJRU5ErkJggg=="};class J extends t.HTMLOverlayContainer{createElement(){super.createElement(),this.element.value=this.get("value")||"",this.element.onchange=(e=>{this.set("value",this.element.value)})}dispose(){super.dispose(),this.targets&&this.targets.forEach(e=>e.shadowRoot.innerHTML="<slot></slot>"),delete this.targets}setElementProperties(e){e.innerHTML=this.state.template}reposition(){super.reposition();var e=this.targets||[],a=this.rootModel&&Array.prototype.slice.call(this.rootModel.overlay.querySelectorAll(this.state.applyTo));a&&a.forEach(a=>{try{!a.shadowRoot&&a.attachShadow({mode:"open"}),a.shadowRoot.innerHTML=this.state.template}catch(e){t.error(e)}let n=e.indexOf(a);n>=0&&e.splice(n,1)}),e.forEach(e=>e.shadowRoot.innerHTML="<slot></slot>"),this.targets=a}get tagName(){return"template"}get fillStyle(){return B}get nature(){return U}}t.Component.register("template",J),e.Button=d,e.CheckBox=E,e.Div=P,e.FieldSet=o,e.Form=l,e.IFrame=f,e.Img=S,e.Input=g,e.InputColor=q,e.InputDate=L,e.InputFile=N,e.InputNumber=R,e.InputSubmit=V,e.Link=k,e.Radio=v,e.Select=m,e.SoapClient=D,e.Template=J,e.TextArea=u,e.Video=_,Object.defineProperty(e,"__esModule",{value:!0})});
